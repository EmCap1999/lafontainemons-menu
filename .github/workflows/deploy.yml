name: Deploy to OVH

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_PATH: /home/ubuntu/lafontainemons/lafontainemons-menu
  FRONTEND_DEST: /var/www/carte.lafontainemons.be

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Application

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.OVH_SSH_HOST }}
          username: ${{ secrets.OVH_SSH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          passphrase: ${{ secrets.OVH_SSH_PASSPHRASE }}
          envs: PROJECT_PATH,FRONTEND_DEST
          script_stop: true
          script: |
            set -e
            cd $PROJECT_PATH

            echo "=== Pulling latest changes ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Cleaning and fixing permissions ==="
            sudo rm -rf node_modules frontend/node_modules backend/node_modules database/node_modules
            sudo chown -R $(whoami):$(whoami) $PROJECT_PATH
            npm ci

            echo "=== Backing up database ==="
            mkdir -p backups
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            docker exec lafontaine-postgres-dev pg_dump -U lafontaine_dev la_fontaine_mons_dev > "backups/$BACKUP_FILE" 2>/dev/null || echo "No existing database to backup"

            echo "=== Restarting Docker services ==="
            docker compose down
            docker compose up -d

            echo "=== Waiting for database to be ready ==="
            until docker exec lafontaine-postgres-dev pg_isready -U lafontaine_dev -d la_fontaine_mons_dev 2>/dev/null; do
              echo "Waiting for PostgreSQL..."
              sleep 2
            done

            echo "=== Running migrations ==="
            npm run db:migrate --workspace=@lafontaine/database

            echo "=== Seeding database ==="
            npm run db:seed --workspace=@lafontaine/database

            echo "=== Cleaning old backups (keep last 10) ==="
            cd $PROJECT_PATH/backups && ls -t *.sql 2>/dev/null | tail -n +11 | xargs -r rm -- || true

            echo "=== Deployment complete ==="